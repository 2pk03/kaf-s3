name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Extract release notes
        run: |
          python - <<'PY'
          import re, pathlib
          changelog = pathlib.Path("CHANGELOG.md").read_text()
          sections = re.split(r"(?m)^## ", changelog)
          if len(sections) < 2:
              raise SystemExit("No version sections found in CHANGELOG.md")
          # sections[0] is header, sections[1] starts with version line
          latest = "## " + sections[1]
          # trim after next version header if present
          latest = re.split(r"(?m)^## ", latest)[0].rstrip()
          pathlib.Path("RELEASE_NOTES.md").write_text(latest + "\n")
          PY

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: RELEASE_NOTES.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
